version: '2'
services:
  test-runner:
    build: .
    container_name: te_unit_tests
    volumes:
      - "${WORKSPACE}:/tE-backend"
      - ./scripts:/scripts
    environment:
      - DJANGO_SETTINGS_MODULE=tRecorderApi.settings_test
      - TESTING=True
    command: bash -c "chmod +x /scripts/wait-for-it.sh 
                      && /scripts/wait-for-it.sh -h db -p 5432 -- rm -rf /tE-backend/tRecorderApi/api/migrations 
                      && mkdir /tE-backend/tRecorderApi/api/migrations
                      && touch /tE-backend/tRecorderApi/api/migrations/__init__.py
                      && cd /tE-backend/tRecorderApi
                      && python3 manage.py makemigrations
                      && python3 manage.py migrate
                      && python3 manage.py jenkins --enable-coverage
                      && coverage html -d reports/htmlcov"
